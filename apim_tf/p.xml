<policies>
  <!-- Runs only when a request maps to some API/operation -->
  <inbound>
    <!-- Optional: fast-fail if Authorization header is missing -->
    <choose>
      <when condition='@(!context.Request.Headers.ContainsKey("Authorization"))'>
        <return-response>
          <set-status code="401" reason="Unauthorized" />
          <set-header name="WWW-Authenticate" exists-action="override">
            <value>Bearer realm="apim", error="invalid_token", error_description="Authentication required"</value>
          </set-header>
          <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
          </set-header>
          <set-body>{"error":"Authentication required"}</set-body>
        </return-response>
      </when>
    </choose>
    <!-- no <base/> at global scope -->
  </inbound>

  <backend />
  <outbound />

  <!-- Runs when NO API/operation matched -->
  <on-error>
    <choose>
      <when condition='@((string)context.LastError?.Reason == "OperationNotFound")'>

        <!-- Decide 401 vs 404 based on Authorization header presence/shape -->
        <set-variable name="authz"
                      value='@((string)context.Request.Headers.GetValueOrDefault("Authorization"))' />
        <set-variable name="isBearer"
                      value='@(!string.IsNullOrEmpty((string)context.Variables["authz"])
                               && ((string)context.Variables["authz"])
                                   .StartsWith("Bearer ", System.StringComparison.OrdinalIgnoreCase))' />

        <choose>
          <!-- Unauthenticated callers (no/malformed header) → 401 -->
          <when condition='@(!(bool)context.Variables["isBearer"])'>
            <return-response>
              <set-status code="401" reason="Unauthorized" />
              <set-header name="WWW-Authenticate" exists-action="override">
                <value>Bearer realm="apim", error="invalid_token", error_description="Authentication required"</value>
              </set-header>
              <set-header name="Content-Type" exists-action="override">
                <value>application/json</value>
              </set-header>
              <set-body>{"error":"Authentication required"}</set-body>
            </return-response>
          </when>

          <!-- Auth header present (looks like Bearer) → 404 JSON safety net -->
          <otherwise>
            <return-response>
              <set-status code="404" reason="Not Found" />
              <set-header name="Content-Type" exists-action="override">
                <value>application/json</value>
              </set-header>
              <set-body>{
                "error":"Route not found",
                "method":"@(context.Request.Method)",
                "path":"@(context.Request.OriginalUrl.PathAndQuery)"
              }</set-body>
            </return-response>
          </otherwise>
        </choose>
      </when>
      <!-- other errors keep default behavior -->
    </choose>
  </on-error>
</policies>
