
az rest --method post \
  --url "https://management.azure.com/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.ApiManagement/service/<APIM_NAME>/namedValues/<NAMED_VALUE_ID>/refreshSecret?api-version=2024-05-01"



revisionId="r6" 

# Then run the command again with this revised variable
# Make sure to use quotes for the URL!
APIM_URL="/subscriptions/$subscriptionId/resourceGroups/$resourceGroup/providers/Microsoft.ApiManagement/service/$serviceName/apis/$apiName/revisions/$revisionId/policies/policy?api-version=$API_VERSION"

az rest --method get --url "$APIM_URL" --query properties.value -o tsv > "$FilePath"

ApiManagementGatewayLlmLog
| where TimeGenerated > ago(1h)
| project TimeGenerated, CorrelationId, RequestMessages, ResponseMessages
| order by TimeGenerated desc


az monitor diagnostic-settings create \
  --name "apim-llm-diagnostic" \
  --resource "/subscriptions/{sub-id}/resourceGroups/{rg}/providers/Microsoft.ApiManagement/service/{apim-name}" \
  --workspace "/subscriptions/{sub-id}/resourceGroups/{rg}/providers/Microsoft.OperationalInsights/workspaces/{workspace-name}" \
  --export-to-resource-specific true \
  --logs '[{"category": "GatewayManagedGenerativeAi", "enabled": true}]'


--metrics '[{"category": "AllMetrics", "enabled": true}]'


ApiManagementGatewayLlmLog
| where TimeGenerated > ago(1h)
| project TimeGenerated, CorrelationId, SequenceNumber, RequestMessages, ResponseMessages
| order by CorrelationId asc, SequenceNumber asc



ApiManagementGatewayLlmLog
| where TimeGenerated > ago(1h)
| order by CorrelationId asc, SequenceNumber asc
| summarize RawFullRequest = make_string(RequestMessages) by CorrelationId, TimeGenerated
| project TimeGenerated, CorrelationId, RawFullRequest


ApiManagementGatewayLlmLog
| where TimeGenerated > ago(1h)
// Ensure chunks are in order before merging
| order by CorrelationId asc, SequenceNumber asc
| summarize FullRawRequest = strcat_array(make_list(RequestMessages), "") 
  by CorrelationId, TimeGenerated
| project TimeGenerated, CorrelationId, FullRawRequest





Feature,Standard Gateway Logs,LLM Gateway Logs
Payload Capture Limit,8 KB per entry,Up to 2 MB per message
Storage Architecture,Single-line records,Chunked Sequence Storage
Handling Large Data,"Truncates after 8,192 bytes",Splits into 32 KB units for reconstruction
